{% extends "base.html" %}

{% block title %}Seznam u≈æivatel≈Ø{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Seznam u≈æivatel≈Ø</h1>
    <a href="{{ request.url_for('admin_new_user_get') }}" class="btn btn-primary">Nov√Ω u≈æivatel</a>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Jm√©no</th>
                <th>Telefon</th>
                <th>Jazyk</th>
                <th>Aktu√°ln√≠ lekce</th>
                <th>Pokrok</th>
                <th>Detail</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.phone }}</td>
                <td>{{ user.language }}</td>
                <td>
                    <span class="badge bg-{% if user.current_lesson_level == 0 %}warning{% else %}primary{% endif %}">
                        Lekce {{ user.current_lesson_level }}
                        {% if user.current_lesson_level == 0 %}
                            <small>(Vstupn√≠ test)</small>
                        {% endif %}
                    </span>
                </td>
                <td>
                    <div class="progress" style="width: 120px;">
                        {% set progress_percent = (user.current_lesson_level / 10) * 100 %}
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ progress_percent }}%" 
                             aria-valuenow="{{ progress_percent }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ progress_percent|int }}%
                        </div>
                    </div>
                    <small class="text-muted">{{ user.current_lesson_level }}/10 lekc√≠</small>
                </td>
                <td>{{ user.detail }}</td>
                <td>
                    <div class="btn-group">
                        <a href="{{ request.url_for('admin_edit_user_get', id=user.id) }}" class="btn btn-sm btn-warning">Upravit</a>
                        <form action="{{ request.url_for('admin_delete_user', user_id=user.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Opravdu chcete smazat tohoto u≈æivatele?')">Smazat</button>
                        </form>
                        
                        <!-- FALLBACK na p≈Øvodn√≠ vol√°n√≠ pro stabilitu -->
                        <form action="{{ request.url_for('admin_call_user', user_id=user.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-success">
                                {% set lesson_level = user.current_lesson_level if user.current_lesson_level is not none else 0 %}
                                {% if lesson_level == 0 %}
                                    üìù Vstupn√≠ test
                                {% else %}
                                    üìû Lekce {{ lesson_level }}
                                {% endif %}
                            </button>
                        </form>
                        
                        <!-- Tlaƒç√≠tko pro reset testu -->
                        <form action="{{ request.url_for('admin_reset_test', user_id=user.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-warning" 
                                    onclick="return confirm('Resetovat test pro u≈æivatele?')" 
                                    title="Resetuje aktivn√≠ test sessions">
                                üîÑ Reset Test
                            </button>
                        </form>
                        
                        <!-- Tlaƒç√≠tko pro postup do dal≈°√≠ lekce (pouze pro adminy) -->
                        {% if user.current_lesson_level < 10 %}
                        <form action="{{ request.url_for('admin_advance_user', user_id=user.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-info" 
                                    onclick="return confirm('Posunout u≈æivatele do dal≈°√≠ lekce?')" 
                                    title="Manu√°ln√≠ postup do dal≈°√≠ lekce">
                                ‚¨ÜÔ∏è Postup
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-4">
    <div class="card">
        <div class="card-header">
            <h5>üìä Legenda syst√©mu lekc√≠</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Struktura lekc√≠:</h6>
                    <ul class="list-unstyled">
                        <li><span class="badge bg-warning">Lekce 0</span> - Vstupn√≠ test (30 ot√°zek, 90% pro postup)</li>
                        <li><span class="badge bg-primary">Lekce 1-10</span> - Pokroƒçil√© lekce obr√°bƒõc√≠ch kapalin</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Postup:</h6>
                    <ul class="list-unstyled">
                        <li>‚úÖ <strong>Automatick√Ω:</strong> AI asistent vyhodnocuje odpovƒõdi</li>
                        <li>‚¨ÜÔ∏è <strong>Manu√°ln√≠:</strong> Admin m≈Ø≈æe posunout u≈æivatele</li>
                        <li>üìû <strong>Vol√°n√≠:</strong> Spust√≠ aktu√°ln√≠ lekci u≈æivatele</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 